<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ config.title }}{% endblock title %}</title>
    <meta name="description" content="{{ config.description }}">
    <link rel="icon" href="{{ get_url(path="favicon.svg") }}">
    <link rel="stylesheet" href="{{ get_url(path="style.css", cachebust=true) }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script>
        (function() {
            const storedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (storedTheme === 'dark' || (!storedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body>
    <header>
        <nav>
            <a href="{{ config.base_url }}" class="logo">{{ config.title }}</a>
            <div class="page-title" id="header-title" aria-hidden="true"></div>
            <div class="nav-links">
                <a href="{{ config.base_url }}">Home</a>
                <a href="{{ get_url(path="@/blog/_index.md") }}">Blog</a>
            </div>
        </nav>
    </header>

    <main>
        {% block content %} {% endblock content %}
    </main>

    <footer>
        <p>&copy; {{ now() | date(format="%Y") }} {{ config.title }} &bull; <a href="https://github.com/{{ config.extra.github }}" target="_blank" rel="noopener noreferrer">GitHub</a></p>
    </footer>
    <button id="theme-toggle" aria-label="Toggle Dark Mode">ðŸŒ“</button>
    <script>
      const toggle = document.getElementById('theme-toggle');
      
      toggle.addEventListener('click', () => {
          const isDark = document.documentElement.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });

      // Dynamic Header Title Script
      (function() {
          const navbar = document.querySelector('header');
          const headerTitle = document.getElementById('header-title');
          // Target the hero section (home) or the post header (blog posts)
          const triggerElement = document.querySelector('.hero, .post-header') || document.querySelector('h1');
          const mainTitle = document.querySelector('h1');

          if (headerTitle && triggerElement && navbar && mainTitle) {
              headerTitle.textContent = mainTitle.textContent;
              
              const checkScroll = () => {
                  try {
                      const triggerRect = triggerElement.getBoundingClientRect();
                      const navbarHeight = navbar.getBoundingClientRect().height;
                      
                      // Trigger when the top of the container hits the bottom of the navbar
                      const isScrolledPast = triggerRect.bottom < navbarHeight;
                      const hasClass = document.body.classList.contains('scrolled-past-title');

                      if (isScrolledPast && !hasClass) {
                          document.body.classList.add('scrolled-past-title');
                      } else if (!isScrolledPast && hasClass) {
                          document.body.classList.remove('scrolled-past-title');
                      }
                  } catch (e) {
                      console.error('Dynamic Title: Error in scroll handler', e);
                  }
              };

              window.addEventListener('scroll', checkScroll, { passive: true });
              checkScroll();
          }
      })();

      // Heading Anchors with Copy to Clipboard
      (function() {
          const headings = document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6');
          
          headings.forEach(heading => {
              if (!heading.id) return;

              const anchor = document.createElement('span');
              anchor.className = 'heading-anchor';
              anchor.textContent = '#';
              anchor.title = 'Copy link to clipboard';
              anchor.setAttribute('aria-hidden', 'true');

              anchor.addEventListener('click', async (e) => {
                  e.stopPropagation();
                  const url = window.location.origin + window.location.pathname + '#' + heading.id;
                  
                  try {
                      await navigator.clipboard.writeText(url);
                      
                      const originalText = anchor.textContent;
                      anchor.textContent = 'Copied!';
                      anchor.classList.add('copied');
                      
                      setTimeout(() => {
                          anchor.textContent = originalText;
                          anchor.classList.remove('copied');
                      }, 2000);
                  } catch (err) {
                      console.error('Failed to copy: ', err);
                  }
              });

              heading.appendChild(anchor);
          });
      })();
    </script>
</body>
</html>
